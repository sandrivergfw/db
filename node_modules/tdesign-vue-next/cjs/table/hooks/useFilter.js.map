{"version":3,"file":"useFilter.js","sources":["../../../src/table/hooks/useFilter.tsx"],"sourcesContent":["import { toRefs, ref, watch, computed, SetupContext } from 'vue';\nimport useClassName from './useClassName';\nimport TButton from '../../button';\nimport { TdPrimaryTableProps, PrimaryTableCol, TableRowData, FilterValue } from '../type';\nimport useDefaultValue from '../../hooks/useDefaultValue';\nimport { useTNodeDefault } from '../../hooks/tnode';\nimport TableFilterController from '../filter-controller';\nimport { useConfig } from '../../hooks/useConfig';\n\nfunction isFilterValueExist(value: any) {\n  const isArrayTrue = value instanceof Array && value.length;\n  const isObject = typeof value === 'object' && !(value instanceof Array);\n  const isObjectTrue = isObject && Object.keys(value).length;\n  return isArrayTrue || isObjectTrue || !['null', '', 'undefined'].includes(String(value));\n}\n\n// 筛选条件不为空，才需要显示筛选结果行\nfunction filterEmptyData(data: FilterValue) {\n  const newFilterValue: FilterValue = {};\n  Object.keys(data).forEach((key) => {\n    const item = data[key];\n    if (isFilterValueExist(item)) {\n      newFilterValue[key] = item;\n    }\n  });\n  return newFilterValue;\n}\n\nexport default function useFilter(props: TdPrimaryTableProps, context: SetupContext) {\n  const primaryTableRef = ref(null);\n  const { t, globalConfig } = useConfig('table');\n  const renderTNode = useTNodeDefault();\n  const { filterValue } = toRefs(props);\n  const { tableFilterClasses, isFocusClass } = useClassName();\n  const isTableOverflowHidden = ref<boolean>();\n\n  // unControl and control\n  const [tFilterValue, setTFilterValue] = useDefaultValue(\n    filterValue,\n    props.defaultFilterValue,\n    props.onFilterChange,\n    'filterValue',\n  );\n\n  // 过滤内部值\n  const innerFilterValue = ref<FilterValue>(tFilterValue.value);\n\n  const hasEmptyCondition = computed(() => {\n    const filterEmpty = filterEmptyData(tFilterValue.value || {});\n    return !tFilterValue.value || !Object.keys(filterEmpty).length;\n  });\n\n  watch([tFilterValue], ([val]) => {\n    innerFilterValue.value = val;\n  });\n\n  function renderFirstFilterRow() {\n    if (hasEmptyCondition.value) return null;\n    const defaultNode = (\n      <div class={tableFilterClasses.result}>\n        <span>\n          {/* 搜索 “{getFilterResultContent()}”， */}\n          {/* 找到 {props.pagination?.total || props.data?.length} 条结果 */}\n          {t(globalConfig.value.searchResultText, {\n            result: getFilterResultContent(),\n            count: props.pagination?.total || props.data?.length,\n          })}\n        </span>\n        <TButton theme=\"primary\" variant=\"text\" onClick={onResetAll}>\n          {globalConfig.value.clearFilterResultButtonText}\n        </TButton>\n      </div>\n    );\n    const filterContent = renderTNode('filterRow');\n    if (props.filterRow && !filterContent) return null;\n    return <div class={tableFilterClasses.inner}>{filterContent || defaultNode}</div>;\n  }\n\n  // 获取搜索条件内容，存在 options 需要获取其 label 显示\n  function getFilterResultContent(): string {\n    const arr: string[] = [];\n    props.columns\n      .filter((col) => col.filter)\n      .forEach((col) => {\n        let value = tFilterValue.value[col.colKey];\n        if (col.filter.list && !['null', '', 'undefined'].includes(String(value))) {\n          const formattedValue = value instanceof Array ? value : [value];\n          const label: string[] = [];\n          col.filter.list.forEach((option) => {\n            if (formattedValue.includes(option.value)) {\n              label.push(option.label);\n            }\n          });\n          value = label.join();\n        }\n        if (isFilterValueExist(value)) {\n          arr.push(`${col.title}：${value}`);\n        }\n      });\n    return arr.join('；');\n  }\n\n  function onInnerFilterChange(val: any, column: PrimaryTableCol) {\n    const filterValue = {\n      ...innerFilterValue.value,\n      [column.colKey]: val,\n    };\n    innerFilterValue.value = filterValue;\n    if (!column.filter.showConfirmAndReset) {\n      emitFilterChange(filterValue, column);\n    }\n  }\n\n  function emitFilterChange(filterValue: FilterValue, column?: PrimaryTableCol) {\n    setTFilterValue(filterValue, { col: column });\n    props.onChange?.({ filter: filterValue }, { trigger: 'filter' });\n  }\n\n  function onReset(column: PrimaryTableCol) {\n    const filterValue: FilterValue = {\n      ...tFilterValue.value,\n      [column.colKey]:\n        column.filter.resetValue ??\n        {\n          single: '',\n          multiple: [],\n          input: '',\n        }[column.filter.type] ??\n        '',\n    };\n    emitFilterChange(filterValue, column);\n  }\n\n  function onResetAll() {\n    emitFilterChange({}, undefined);\n  }\n\n  function onConfirm(column: PrimaryTableCol) {\n    emitFilterChange(innerFilterValue.value, column);\n  }\n\n  // 图标：内置图标，组件自定义图标，全局配置图标\n  function renderFilterIcon({ col }: { col: PrimaryTableCol<TableRowData>; colIndex: number }) {\n    return (\n      <TableFilterController\n        v-slots={{ filterIcon: context.slots.filterIcon }}\n        column={col}\n        filterIcon={props.filterIcon}\n        tFilterValue={tFilterValue.value}\n        innerFilterValue={innerFilterValue.value}\n        tableFilterClasses={tableFilterClasses}\n        isFocusClass={isFocusClass}\n        onReset={onReset}\n        onConfirm={onConfirm}\n        onInnerFilterChange={onInnerFilterChange}\n        primaryTableElement={primaryTableRef.value?.$el}\n        onVisibleChange={onPopupVisibleChange}\n      ></TableFilterController>\n    );\n  }\n\n  function setFilterPrimaryTableRef(primaryTableElement: any) {\n    primaryTableRef.value = primaryTableElement;\n  }\n\n  function onPopupVisibleChange(visible: boolean) {\n    if (visible && !isTableOverflowHidden.value) {\n      isTableOverflowHidden.value = !visible;\n    }\n  }\n\n  return {\n    hasEmptyCondition,\n    isTableOverflowHidden,\n    renderFilterIcon,\n    renderFirstFilterRow,\n    setFilterPrimaryTableRef,\n  };\n}\n"],"names":["isFilterValueExist","value","isArrayTrue","Array","length","isObject","_typeof","isObjectTrue","Object","keys","includes","String","filterEmptyData","data","newFilterValue","forEach","key","item","useFilter","props","context","primaryTableRef","ref","useConfig","t","globalConfig","renderTNode","useTNodeDefault","toRefs","filterValue","useClassName","tableFilterClasses","isFocusClass","isTableOverflowHidden","useDefaultValue","defaultFilterValue","onFilterChange","_slicedToArray","tFilterValue","setTFilterValue","innerFilterValue","hasEmptyCondition","computed","filterEmpty","watch","val","renderFirstFilterRow","defaultNode","_createVNode","result","searchResultText","getFilterResultContent","count","pagination","total","onResetAll","clearFilterResultButtonText","filterContent","filterRow","inner","arr","columns","filter","col","colKey","list","formattedValue","label","option","push","join","title","onInnerFilterChange","column","showConfirmAndReset","emitFilterChange","onChange","trigger","onReset","resetValue","single","multiple","input","type","onConfirm","renderFilterIcon","TableFilterController","filterIcon","$el","onPopupVisibleChange","slots","setFilterPrimaryTableRef","primaryTableElement","visible"],"mappings":"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"}