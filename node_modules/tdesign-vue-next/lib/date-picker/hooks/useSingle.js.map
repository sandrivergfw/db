{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import { ref, computed, watchEffect } from 'vue';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-vue-next';\nimport dayjs from 'dayjs';\n\nimport { useTNodeJSX } from '../../hooks/tnode';\nimport { useFormDisabled } from '../../form/hooks';\nimport { usePrefixClass, useConfig } from '../../hooks/useConfig';\nimport { useGlobalIcon } from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps, DateValue } from '../type';\nimport {\n  isValidDate,\n  formatDate,\n  formatTime,\n  getDefaultFormat,\n  parseToDayjs,\n} from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\n\nexport default function useSingle(props: TdDatePickerProps) {\n  const COMPONENT_NAME = usePrefixClass('date-picker');\n  const { globalConfig } = useConfig('datePicker');\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const disabled = useFormDisabled();\n  const renderTNodeJSX = useTNodeJSX();\n\n  const inputRef = ref();\n\n  const { value, onChange, time, month, year, cacheValue } = useSingleValue(props);\n\n  const formatRef = computed(() =>\n    getDefaultFormat({\n      mode: props.mode,\n      format: props.format,\n      valueType: props.valueType,\n      enableTimePicker: props.enableTimePicker,\n    }),\n  );\n\n  const popupVisible = ref(false);\n  const isHoverCell = ref(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const inputValue = ref(formatDate(value.value, { format: formatRef.value.format }));\n\n  // input 设置\n  const inputProps = computed(() => ({\n    ...props.inputProps,\n    ref: inputRef,\n    prefixIcon: () => renderTNodeJSX('prefixIcon'),\n    readonly: !props.allowInput,\n    placeholder: props.placeholder || globalConfig.value.placeholder[props.mode],\n    suffixIcon: () => {\n      return renderTNodeJSX('suffixIcon') || <CalendarIcon />;\n    },\n    class: [\n      {\n        [`${COMPONENT_NAME.value}__input--placeholder`]: isHoverCell.value,\n      },\n    ],\n    onClear: (context: { e: InputEvent }) => {\n      context?.e?.stopPropagation();\n      popupVisible.value = false;\n      onChange?.('', { dayjsValue: dayjs(), trigger: 'clear' });\n    },\n    onBlur: (val: string, context: { e: FocusEvent }) => {\n      props.onBlur?.({ value: val, e: context.e });\n    },\n    onFocus: (_: string, { e }: { e: FocusEvent }) => {\n      props.onFocus?.({ value: value.value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      inputValue.value = val;\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, formatRef.value.format)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val, formatRef.value.timeFormat);\n      !Number.isNaN(newYear) && (year.value = newYear);\n      !Number.isNaN(newMonth) && (month.value = newMonth);\n      !Number.isNaN(newTime) && (time.value = newTime);\n    },\n    onEnter: (val: string) => {\n      if (!val) {\n        onChange('', { dayjsValue: dayjs(), trigger: 'enter' });\n        popupVisible.value = false;\n        return;\n      }\n\n      if (!isValidDate(val, formatRef.value.format) && !isValidDate(value.value, formatRef.value.format)) return;\n\n      popupVisible.value = false;\n      if (isValidDate(val, formatRef.value.format)) {\n        onChange?.(\n          formatDate(val, { format: formatRef.value.format, targetFormat: formatRef.value.valueType }) as DateValue,\n          {\n            dayjsValue: parseToDayjs(val, formatRef.value.format),\n            trigger: 'enter',\n          },\n        );\n      } else if (isValidDate(value.value, formatRef.value.format)) {\n        inputValue.value = formatDate(value.value, {\n          format: formatRef.value.format,\n        });\n      } else {\n        inputValue.value = '';\n      }\n    },\n  }));\n\n  // popup 设置\n  const popupProps = computed(() => ({\n    expandAnimation: true,\n    ...props.popupProps,\n    disabled: disabled.value,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: [props.popupProps?.overlayClassName, `${COMPONENT_NAME.value}__panel-container`],\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (disabled.value) return;\n      // 这里劫持了进一步向 popup 传递的 onVisibleChange 事件，为了保证可以在 Datepicker 中使用 popupProps.onVisibleChange，故此处理\n      props.popupProps?.onVisibleChange?.(visible, context);\n      // 输入框点击不关闭面板\n      if (context.trigger === 'trigger-element-click') {\n        popupVisible.value = true;\n        return;\n      }\n      popupVisible.value = visible;\n    },\n  }));\n\n  watchEffect(() => {\n    if (!value.value) {\n      inputValue.value = '';\n      return;\n    }\n    if (!isValidDate(value.value, formatRef.value.format)) return;\n\n    inputValue.value = formatDate(value.value, {\n      format: formatRef.value.format,\n    });\n  });\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    isHoverCell,\n    onChange,\n  };\n}\n"],"names":["useSingle","props","COMPONENT_NAME","usePrefixClass","useConfig","globalConfig","useGlobalIcon","CalendarIcon","TdCalendarIcon","disabled","useFormDisabled","renderTNodeJSX","useTNodeJSX","inputRef","ref","useSingleValue","value","onChange","time","month","year","cacheValue","formatRef","computed","getDefaultFormat","mode","format","valueType","enableTimePicker","popupVisible","isHoverCell","inputValue","formatDate","inputProps","prefixIcon","readonly","allowInput","placeholder","suffixIcon","_createVNode","onClear","context","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","onFocus","_","isValidDate","newMonth","newYear","newTime","formatTime","timeFormat","Number","isNaN","onEnter","targetFormat","parseToDayjs","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","watchEffect"],"mappings":"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"}