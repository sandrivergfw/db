{"version":3,"file":"container.mjs","sources":["../../src/popup/container.tsx"],"sourcesContent":["import { defineComponent, onMounted, onUnmounted, ref, Fragment, Text, watch, PropType, VNode, Teleport } from 'vue';\nimport { getAttach } from '../utils/dom';\nimport props from './props';\n\nfunction filterEmpty(children: VNode[] = []) {\n  const vnodes: VNode[] = [];\n  children.forEach((child) => {\n    if (Array.isArray(child)) {\n      vnodes.push(...child);\n    } else if (child.type === Fragment) {\n      vnodes.push(...filterEmpty(child.children as VNode[]));\n    } else {\n      vnodes.push(child);\n    }\n  });\n  return vnodes.filter(\n    (c) =>\n      !(\n        c &&\n        ((typeof Comment !== 'undefined' && c.type === Comment) ||\n          (c.type === Fragment && c.children.length === 0) ||\n          (c.type === Text && (c.children as string).trim() === ''))\n      ),\n  );\n}\n\nfunction isContentRectChanged(rect1: DOMRectReadOnly, rect2: DOMRectReadOnly) {\n  if (!rect1 || !rect2) return;\n  if (['width', 'height', 'x', 'y'].some((k) => rect1[k] !== rect2[k])) {\n    return true;\n  }\n  return false;\n}\n\nfunction observeResize(elm: HTMLElement, cb: (rect: DOMRectReadOnly) => void) {\n  if (!window?.ResizeObserver || !elm) return;\n  let prevContentRect = null as DOMRectReadOnly;\n  const ro = new ResizeObserver((entries = []) => {\n    const { contentRect } = entries[0] || {};\n    if (isContentRectChanged(contentRect, prevContentRect)) {\n      prevContentRect = contentRect;\n      cb(contentRect);\n      return;\n    }\n    // omit initial change\n    if (!prevContentRect) {\n      prevContentRect = contentRect;\n    }\n  });\n\n  if (elm.nodeType !== 1) return;\n\n  ro.observe(elm);\n  return function () {\n    ro.unobserve(elm);\n  };\n}\n\nfunction useObserveResize(elm: () => HTMLElement, cb: Parameters<typeof observeResize>[1]) {\n  let cleanOR: ReturnType<typeof observeResize>;\n  onMounted(() => {\n    cleanOR = observeResize(elm(), cb);\n  });\n  onUnmounted(() => {\n    cleanOR?.();\n  });\n}\n\n// eslint-disable-next-line vue/one-component-per-file\nconst Trigger = defineComponent({\n  emits: ['resize'],\n  data() {\n    return {\n      cleanOR: null,\n    };\n  },\n  mounted() {\n    // There is no better way to get the root element than `this.$el`\n    this.cleanOR = observeResize(this.$el, () => {\n      this.$emit('resize');\n    });\n  },\n  unmounted() {\n    this.cleanOR?.();\n  },\n  render() {\n    const children = filterEmpty(this.$slots.default());\n    if (children.length > 1 || children[0]?.type === Text) {\n      return <span>{children}</span>;\n    }\n    return children[0];\n  },\n});\n\n// eslint-disable-next-line vue/one-component-per-file\nconst Content = defineComponent({\n  emits: ['resize'],\n  setup(props, { emit }) {\n    const el = ref(null);\n    useObserveResize(\n      () => el.value.children[0],\n      () => {\n        emit('resize');\n      },\n    );\n    return { el };\n  },\n  render() {\n    return (\n      <div ref=\"el\" style=\"position: absolute; top: 0px; left: 0px; width: 100%\">\n        {this.$slots.default()}\n      </div>\n    );\n  },\n});\n\n// eslint-disable-next-line vue/one-component-per-file\nexport default defineComponent({\n  inheritAttrs: false,\n  props: {\n    parent: Object,\n    visible: Boolean,\n    attach: props.attach,\n    forwardRef: Function as PropType<(el: HTMLElement) => void>,\n  },\n  emits: ['resize', 'contentMounted'],\n  setup(props, { emit }) {\n    const triggerRef = ref<VNode & { $el: HTMLElement }>(null);\n    const mountContent = ref(false);\n\n    onMounted(() => {\n      requestAnimationFrame(() => {\n        mountContent.value = props.visible;\n      });\n      props.forwardRef(triggerRef.value.$el);\n    });\n\n    watch(\n      () => props.visible,\n      (visible) => {\n        if (visible) {\n          mountContent.value = props.visible;\n        }\n      },\n    );\n\n    return {\n      mountContent,\n      triggerRef,\n      unmountContent() {\n        mountContent.value = false;\n      },\n      emitResize: () => {\n        emit('resize');\n      },\n      emitContentMounted: () => {\n        emit('contentMounted');\n      },\n    };\n  },\n  render() {\n    return (\n      <Fragment>\n        <Trigger\n          {...{\n            class: this.$attrs.class,\n          }}\n          ref=\"triggerRef\"\n          onResize={this.emitResize}\n        >\n          {this.$slots.default()}\n        </Trigger>\n        {this.mountContent && (\n          <Teleport to={getAttach(this.attach, this.triggerRef?.$el)}>\n            <Content onResize={this.emitResize} onVnodeMounted={this.emitContentMounted}>\n              {this.$slots.content && this.$slots.content()}\n            </Content>\n          </Teleport>\n        )}\n      </Fragment>\n    );\n  },\n});\n"],"names":["_isVNode","filterEmpty","children","vnodes","forEach","child","Array","isArray","push","type","Fragment","filter","c","Comment","length","Text","trim","isContentRectChanged","rect1","rect2","some","k","observeResize","elm","cb","window","ResizeObserver","prevContentRect","ro","entries","contentRect","nodeType","observe","unobserve","useObserveResize","cleanOR","onMounted","onUnmounted","Trigger","defineComponent","emits","data","mounted","$el","$emit","unmounted","render","$slots","_createVNode","Content","setup","props","emit","el","ref","value","inheritAttrs","parent","Object","visible","Boolean","attach","forwardRef","Function","triggerRef","mountContent","requestAnimationFrame","watch","unmountContent","emitResize","emitContentMounted","_Fragment","_mergeProps","$attrs","getAttach","content"],"mappings":"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"}