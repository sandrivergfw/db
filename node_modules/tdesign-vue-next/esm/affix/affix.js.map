{"version":3,"file":"affix.js","sources":["../../src/affix/affix.tsx"],"sourcesContent":["import { ref, watch, nextTick, onMounted, onBeforeUnmount, defineComponent, onActivated, onDeactivated } from 'vue';\nimport isFunction from 'lodash/isFunction';\nimport { on, off, getScrollContainer } from '../utils/dom';\nimport props from './props';\nimport { ScrollContainerElement } from '../common';\nimport { usePrefixClass } from '../hooks/useConfig';\nimport { useTNodeJSX } from '../hooks/tnode';\n\nexport default defineComponent({\n  name: 'TAffix',\n  props,\n  emits: ['fixedChange'],\n  setup(props, context) {\n    const COMPONENT_NAME = usePrefixClass('affix');\n    const renderTNodeJSX = useTNodeJSX();\n\n    const affixWrapRef = ref<HTMLElement>(null);\n    const affixRef = ref<HTMLElement>(null);\n    const placeholderEL = ref(document.createElement('div')); // 占位节点\n    const ticking = ref(false);\n    const binded = ref(false);\n\n    const scrollContainer = ref<ScrollContainerElement>();\n\n    const handleScroll = () => {\n      if (!ticking.value) {\n        window.requestAnimationFrame(() => {\n          const {\n            top: wrapToTop,\n            width: wrapWidth,\n            height: wrapHeight,\n          } = affixWrapRef.value.getBoundingClientRect() ?? { top: 0, width: 0, height: 0 }; // top = 节点到页面顶部的距离，包含 scroll 中的高度\n\n          let containerTop = 0; // containerTop = 容器到页面顶部的距离\n          if (scrollContainer.value instanceof HTMLElement) {\n            containerTop = scrollContainer.value.getBoundingClientRect().top;\n          }\n\n          let fixedTop: number | false; // 0 -1 false 都有具体的意义\n          const calcTop = wrapToTop - containerTop; // 节点顶部到 container 顶部的距离\n\n          const containerHeight =\n            scrollContainer.value[scrollContainer.value instanceof Window ? 'innerHeight' : 'clientHeight'] -\n            wrapHeight;\n          const calcBottom = containerTop + containerHeight - props.offsetBottom; // 计算 bottom 相对应的 top 值\n\n          if (props.offsetTop !== undefined && calcTop <= props.offsetTop) {\n            // top 的触发\n            fixedTop = containerTop + props.offsetTop;\n          } else if (props.offsetBottom !== undefined && wrapToTop >= calcBottom) {\n            // bottom 的触发\n            fixedTop = calcBottom;\n          } else {\n            fixedTop = false;\n          }\n\n          if (affixRef.value) {\n            const affixed = fixedTop !== false;\n            const placeholderStatus = affixWrapRef.value.contains(placeholderEL.value);\n\n            if (affixed) {\n              affixRef.value.className = COMPONENT_NAME.value;\n              affixRef.value.style.top = `${fixedTop}px`;\n              affixRef.value.style.width = `${wrapWidth}px`;\n              affixRef.value.style.height = `${wrapHeight}px`;\n\n              if (props.zIndex) {\n                affixRef.value.style.zIndex = `${props.zIndex}`;\n              }\n\n              if (!placeholderStatus) {\n                placeholderEL.value.style.width = `${wrapWidth}px`;\n                placeholderEL.value.style.height = `${wrapHeight}px`;\n                affixWrapRef.value.appendChild(placeholderEL.value);\n              }\n            } else {\n              affixRef.value.removeAttribute('class');\n              affixRef.value.removeAttribute('style');\n              placeholderStatus && placeholderEL.value.remove();\n            }\n\n            context.emit('fixedChange', affixed, { top: Number(fixedTop) });\n            if (isFunction(props.onFixedChange)) props.onFixedChange(affixed, { top: Number(fixedTop) });\n          }\n\n          ticking.value = false;\n        });\n        ticking.value = true;\n      }\n    };\n\n    const bindScroll = async () => {\n      await nextTick();\n      if (binded.value) return;\n      scrollContainer.value = getScrollContainer(props.container);\n      on(scrollContainer.value, 'scroll', handleScroll);\n      on(window, 'resize', handleScroll);\n      binded.value = true;\n    };\n\n    const unbindScroll = () => {\n      if (!scrollContainer.value || !binded.value) return;\n      off(scrollContainer.value, 'scroll', handleScroll);\n      off(window, 'resize', handleScroll);\n      binded.value = false;\n    };\n\n    watch(\n      () => props.offsetTop,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.offsetBottom,\n      () => {\n        handleScroll();\n      },\n    );\n\n    watch(\n      () => props.zIndex,\n      () => {\n        handleScroll();\n      },\n    );\n\n    onMounted(bindScroll);\n\n    onActivated(bindScroll);\n\n    onDeactivated(unbindScroll);\n\n    onBeforeUnmount(unbindScroll);\n\n    return {\n      affixWrapRef,\n      affixRef,\n      bindScroll,\n      unbindScroll,\n      handleScroll,\n      scrollContainer,\n      renderTNodeJSX,\n    };\n  },\n  render() {\n    return (\n      <div ref=\"affixWrapRef\">\n        <div ref=\"affixRef\">{this.renderTNodeJSX('default')}</div>\n      </div>\n    );\n  },\n});\n"],"names":["defineComponent","name","props","emits","setup","context","COMPONENT_NAME","usePrefixClass","renderTNodeJSX","useTNodeJSX","affixWrapRef","ref","affixRef","placeholderEL","document","createElement","ticking","binded","scrollContainer","handleScroll","value","window","requestAnimationFrame","getBoundingClientRect","top","width","height","wrapToTop","wrapWidth","wrapHeight","containerTop","HTMLElement","fixedTop","calcTop","containerHeight","Window","calcBottom","offsetBottom","offsetTop","affixed","placeholderStatus","contains","className","style","zIndex","appendChild","removeAttribute","remove","emit","Number","isFunction","onFixedChange","bindScroll","nextTick","getScrollContainer","container","on","unbindScroll","off","watch","onMounted","onActivated","onDeactivated","onBeforeUnmount","render","_createVNode"],"mappings":"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"}